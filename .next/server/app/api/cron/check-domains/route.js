"use strict";(()=>{var e={};e.id=914,e.ids=[914],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4325:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>k,patchFetch:()=>D,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>p,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>g});var s={};a.r(s),a.d(s,{GET:()=>c});var r=a(5419),i=a(9108),o=a(9678),u=a(4490),n=a(4908),d=a(8070);let l=process.env.CRON_SECRET;async function c(e){if(e.headers.get("Authorization")!==`Bearer ${l}`)return new d.Z("Unauthorized",{status:401});try{for(let e of(await u._.domain.findMany())){let[t,a,s]=await Promise.all([(0,n.RT)(e.name,e.dkimSelector),(0,n.Hr)(e.name),(0,n.Lw)(e.name)]);await u._.domain.update({where:{id:e.id},data:{dkim:t.details?`${t.value} (${t.details})`:t.value,spf:a.details?`${a.value} (${a.details})`:a.value,dmarc:s.details?`${s.value} (${s.details})`:s.value,dkimStatus:t.status,spfStatus:a.status,dmarcStatus:s.status,lastChecked:new Date}})}return d.Z.json({success:!0,message:"Domains checked successfully"})}catch(e){return console.error("Error checking domains:",e),d.Z.json({success:!1,error:"Failed to check domains"},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/check-domains/route",pathname:"/api/cron/check-domains",filename:"route",bundlePath:"app/api/cron/check-domains/route"},resolvedPagePath:"/Users/robmoran/Documents/Email Builds/domain-dashboard/src/app/api/cron/check-domains/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:p,headerHooks:h,staticGenerationBailout:g}=m,k="/api/cron/check-domains/route";function D(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:v})}},4490:(e,t,a)=>{a.d(t,{_:()=>r});var s=a(3524);let r=global.prisma||new s.PrismaClient},4908:(e,t,a)=>{a.d(t,{RT:()=>i,Lw:()=>u,Hr:()=>o});let s=require("dns");async function r(e){let t=new Promise((e,t)=>{setTimeout(()=>t(Error("DNS lookup timeout")),5e3)});try{return await Promise.race([s.promises.resolveTxt(e),t])}catch(e){if("DNS lookup timeout"===e.message)throw Error("DNS lookup timed out after 5 seconds");throw e}}async function i(e,t){try{let a=(await r(`${t}._domainkey.${e}`)).flat().join(" ");if(!a.includes("v=DKIM1"))return{status:"advisory",value:a,details:"Record found but missing v=DKIM1 tag"};let s=["k=","p="].filter(e=>!a.includes(e));if(s.length>0)return{status:"advisory",value:a,details:`Missing required tags: ${s.join(", ")}`};return{status:"success",value:a}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"No DKIM record found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}async function o(e){try{let t=(await r(e)).flat().find(e=>e.startsWith("v=spf1"));if(!t)return{status:"not-configured",value:"",details:"No SPF record found"};if(!t.match(/v=spf1( [+-]?(all|include:[^\s]+|ip4:[^\s]+|ip6:[^\s]+|a|mx|ptr|exists:[^\s]+))*( [+-]all)?$/))return{status:"advisory",value:t,details:"Invalid SPF syntax"};return{status:"success",value:t}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"Domain not found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}async function u(e){try{let t=(await r(`_dmarc.${e}`)).flat().join(" ");if(!t.includes("v=DMARC1"))return{status:"advisory",value:t,details:"Record found but missing v=DMARC1 tag"};let a=["p="].filter(e=>!t.includes(e));if(a.length>0)return{status:"advisory",value:t,details:`Missing required tags: ${a.join(", ")}`};return{status:"success",value:t}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"No DMARC record found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[638,206],()=>a(4325));module.exports=s})();
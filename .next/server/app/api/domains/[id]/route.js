"use strict";(()=>{var e={};e.id=19,e.ids=[19],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7344:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>E,patchFetch:()=>k,requestAsyncStorage:()=>D,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>j});var s={};r.r(s),r.d(s,{DELETE:()=>p,GET:()=>f,PATCH:()=>v,dynamic:()=>c,runtime:()=>m});var a=r(5419),i=r(9108),o=r(9678),n=r(8070),u=r(4490),d=r(4908),l=r(3524);let c="force-dynamic",m="nodejs";async function f(e,t){let{id:r}=t.params;if(!r)return n.Z.json({error:"Domain ID is required"},{status:400});try{let e=await u._.domain.findUnique({where:{id:r}});if(!e)return n.Z.json({error:"Domain not found"},{status:404});let[t,s,a]=await Promise.all([(0,d.RT)(e.name,e.dkimSelector),(0,d.Hr)(e.name),(0,d.Lw)(e.name)]),i=e.dismissedAdvisories?e.dismissedAdvisories.split(",").filter(Boolean):[],o=await u._.domain.update({where:{id:r},data:{dkim:t.details?`${t.value} (${t.details})`:t.value,spf:s.details?`${s.value} (${s.details})`:s.value,dmarc:a.details?`${a.value} (${a.details})`:a.value,dkimStatus:t.status,spfStatus:s.status,dmarcStatus:a.status,lastChecked:new Date}});return n.Z.json({...o,lastChecked:o.lastChecked.toISOString(),dismissedAdvisories:i,dkimStatus:t.status,spfStatus:s.status,dmarcStatus:a.status})}catch(e){return console.error("Error fetching domain:",e),n.Z.json({error:"Failed to fetch domain"},{status:500})}}async function p(e,t){let{id:r}=t.params;if(!r)return n.Z.json({error:"Domain ID is required"},{status:400});try{if(!await u._.domain.findUnique({where:{id:r}}))return n.Z.json({error:"Domain not found"},{status:404});return await u._.domain.delete({where:{id:r}}),new Response(null,{status:204})}catch(e){if(console.error("Error deleting domain:",e),e instanceof l.Prisma.PrismaClientKnownRequestError)return n.Z.json({error:`Database error: ${e.message}`},{status:500});return n.Z.json({error:"Failed to delete domain"},{status:500})}}async function v(e,t){let{id:r}=t.params;if(!r)return n.Z.json({error:"Domain ID is required"},{status:400});try{let{dismissedAdvisories:t,name:s,dkimSelector:a,espId:i}=await e.json();if(void 0!==t){if(!Array.isArray(t))return n.Z.json({error:"dismissedAdvisories must be an array"},{status:400});if(!await u._.domain.findUnique({where:{id:r},select:{id:!0,dismissedAdvisories:!0,lastChecked:!0}}))return n.Z.json({error:"Domain not found"},{status:404});let e=t.filter(e=>"string"==typeof e).map(e=>e.trim()).filter(Boolean).join(",");if(e.length>1e3)return n.Z.json({error:"Too many advisories to store"},{status:400});let s=await u._.domain.update({where:{id:r},data:{dismissedAdvisories:e||null},include:{esp:!0}});return n.Z.json({...s,lastChecked:s.lastChecked.toISOString(),dismissedAdvisories:e?e.split(","):[]})}if(s||a||void 0!==i){if(s){if(!/^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/i.test(s))return n.Z.json({error:"Invalid domain format"},{status:400});if(await u._.domain.findFirst({where:{name:s,NOT:{id:r}}}))return n.Z.json({error:"Domain already exists"},{status:400})}if(a&&!/^[a-z0-9][a-z0-9-]*[a-z0-9]$/i.test(a))return n.Z.json({error:"Invalid DKIM selector format"},{status:400});let e={};s&&(e.name=s),a&&(e.dkimSelector=a),void 0!==i&&(e.espId=i||null);let t=await u._.domain.update({where:{id:r},data:e,include:{esp:!0}});return n.Z.json(t)}return n.Z.json({error:"No valid update parameters provided"},{status:400})}catch(e){return console.error("Error in PATCH /api/domains/[id]:",e),n.Z.json({error:"Failed to update domain"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/domains/[id]/route",pathname:"/api/domains/[id]",filename:"route",bundlePath:"app/api/domains/[id]/route"},resolvedPagePath:"/Users/robmoran/Documents/Email Builds/domain-dashboard/src/app/api/domains/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:D,staticGenerationAsyncStorage:w,serverHooks:g,headerHooks:y,staticGenerationBailout:j}=h,E="/api/domains/[id]/route";function k(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},4490:(e,t,r)=>{r.d(t,{_:()=>a});var s=r(3524);let a=global.prisma||new s.PrismaClient},4908:(e,t,r)=>{r.d(t,{RT:()=>i,Lw:()=>n,Hr:()=>o});let s=require("dns");async function a(e){let t=new Promise((e,t)=>{setTimeout(()=>t(Error("DNS lookup timeout")),5e3)});try{return await Promise.race([s.promises.resolveTxt(e),t])}catch(e){if("DNS lookup timeout"===e.message)throw Error("DNS lookup timed out after 5 seconds");throw e}}async function i(e,t){try{let r=(await a(`${t}._domainkey.${e}`)).flat().join(" ");if(!r.includes("v=DKIM1"))return{status:"advisory",value:r,details:"Record found but missing v=DKIM1 tag"};let s=["k=","p="].filter(e=>!r.includes(e));if(s.length>0)return{status:"advisory",value:r,details:`Missing required tags: ${s.join(", ")}`};return{status:"success",value:r}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"No DKIM record found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}async function o(e){try{let t=(await a(e)).flat().find(e=>e.startsWith("v=spf1"));if(!t)return{status:"not-configured",value:"",details:"No SPF record found"};if(!t.match(/v=spf1( [+-]?(all|include:[^\s]+|ip4:[^\s]+|ip6:[^\s]+|a|mx|ptr|exists:[^\s]+))*( [+-]all)?$/))return{status:"advisory",value:t,details:"Invalid SPF syntax"};return{status:"success",value:t}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"Domain not found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}async function n(e){try{let t=(await a(`_dmarc.${e}`)).flat().join(" ");if(!t.includes("v=DMARC1"))return{status:"advisory",value:t,details:"Record found but missing v=DMARC1 tag"};let r=["p="].filter(e=>!t.includes(e));if(r.length>0)return{status:"advisory",value:t,details:`Missing required tags: ${r.join(", ")}`};return{status:"success",value:t}}catch(e){if("ENOTFOUND"===e.code||"ENODATA"===e.code)return{status:"not-configured",value:"",details:"No DMARC record found"};if("ETIMEOUT"===e.code)return{status:"error",value:"",details:"DNS lookup timed out"};return{status:"error",value:"",details:e.message}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,206],()=>r(7344));module.exports=s})();